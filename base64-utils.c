#include "base64-utils.h"

char* bytesToB64(uint8_t* bytes, size_t size) {	
    // [NSData dataWithBytes:(const void*)spray_data length:size]
	id nsdata = objc_msgSend((id)objc_getClass("NSData"), 
			sel_registerName("dataWithBytes:length:"), (const void*)bytes, size);
	// [nsdata base64EncodedStringWithOptions:0]
	id base64_nsstring = objc_msgSend(nsdata, 
			sel_registerName("base64EncodedStringWithOptions:"), 0);
	// [base64_encoded cStringUsingEncoding:NSASCIIStringEncoding]
	char* c_string = (char*)objc_msgSend(base64_nsstring, 
			sel_registerName("cStringUsingEncoding:"), NSASCIIStringEncoding);

	// The returned C string is guaranteed to be valid only until either the receiver is freed, 
	// or until the current memory is emptied, whichever occurs first.
	char* c_string_copied = malloc(strlen(c_string)+1);
	memcpy(c_string_copied, c_string, strlen(c_string)+1);

	// release objects
	objc_msgSend(nsdata, sel_registerName("release"));
	objc_msgSend(base64_nsstring, sel_registerName("release"));
	return c_string_copied;
}



uint8_t* b64ToBytes(char* b64, size_t* size) {
	// [NSString alloc]
	id nsstring_class = objc_msgSend((id)objc_getClass("NSString"), sel_registerName("alloc"));
	// [NSString initWithBytes: b64 length: strlen(b64)+1 encoding: NSASCIIStringEncoding]
	id b64_nsstring = objc_msgSend(nsstring_class, 
			sel_registerName("initWithBytes:length:encoding:"), (const void*)b64, strlen(b64)+1, 
			NSASCIIStringEncoding);

	// [NSData alloc]
	id nsdata_class = objc_msgSend((id)objc_getClass("NSData"), sel_registerName("alloc"));
	// [nsdata initWithBase64EncodedString:base64String options:0];
	id nsdata = objc_msgSend(nsdata_class, 
			sel_registerName("initWithBase64EncodedString:options:"), b64_nsstring, 
			NSDataBase64DecodingIgnoreUnknownCharacters);

	unsigned long len = (unsigned long)objc_msgSend(nsdata, sel_registerName("length"));
	void* bytes = objc_msgSend(nsdata, sel_registerName("bytes"));

	uint8_t* bytes_copied = malloc(len);
	memcpy(bytes_copied, bytes, len);

	
	objc_msgSend(nsdata, sel_registerName("release"));
	objc_msgSend(b64_nsstring, sel_registerName("release"));

	*size = (size_t)len;
	return bytes_copied;
}