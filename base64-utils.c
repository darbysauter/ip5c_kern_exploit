#include "base64-utils.h"

char* bytesToB64(uint8_t* bytes, size_t size) {	
    // [NSData dataWithBytes:(const void*)spray_data length:size]
	id nsdata = objc_msgSend((id)objc_getClass("NSData"), 
			sel_registerName("dataWithBytes:length:"), (const void*)bytes, size);
	// [nsdata base64EncodedStringWithOptions:0]
	id base64_nsstring = objc_msgSend(nsdata, 
			sel_registerName("base64EncodedStringWithOptions:"), 0);
	// [base64_encoded cStringUsingEncoding:NSASCIIStringEncoding]
	char* c_string = (char*)objc_msgSend(base64_nsstring, 
			sel_registerName("cStringUsingEncoding:"), NSASCIIStringEncoding);

	// The returned C string is guaranteed to be valid only until either the receiver is freed, 
	// or until the current memory is emptied, whichever occurs first.
	char* c_string_copied = malloc(strlen(c_string)+1);
	memcpy(c_string_copied, c_string, strlen(c_string)+1);

	// release objects
	objc_msgSend(nsdata, sel_registerName("release"));
	objc_msgSend(base64_nsstring, sel_registerName("release"));
	return c_string_copied;
}