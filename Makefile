bin=build/bin
CC=$(THEOS)/toolchain/linux/iphone/bin/clang
CCFLAGS=-target armv7-apple-darwin-macho -arch armv7
LDFLAGS=-framework IOKit -lobjc -framework Foundation
SDK=$(THEOS)/sdks/iPhoneOS7.0.sdk
INCLUDE=-I$(SDK)/System/Library/Frameworks/IOKit.framework/Versions/A/Headers
FRAMEWORKS=-F$(SDK)/System/Library/Frameworks/
DEVICE_IP=10.0.0.105

all: $(bin) $(bin)/poc

$(bin):
	mkdir -p $(bin)

$(bin)/poc: $(bin)/poc.o $(bin)/iosurface.o $(bin)/applevxd390.o $(bin)/base64-utils.o \
		$(bin)/mach-ports.o $(bin)/gc.o $(bin)/pipes.o
	$(CC) $(CCFLAGS) $(LDFLAGS) $(INCLUDE) $(FRAMEWORKS) -isysroot $(SDK) -o $(bin)/poc \
	$(bin)/poc.o $(bin)/iosurface.o $(bin)/applevxd390.o $(bin)/base64-utils.o \
	$(bin)/mach-ports.o $(bin)/gc.o $(bin)/pipes.o

$(bin)/poc.o: poc.c
	$(CC) $(CCFLAGS) $(INCLUDE) $(FRAMEWORKS) -isysroot $(SDK) -c poc.c -o $(bin)/poc.o

$(bin)/iosurface.o: iosurface.c iosurface.h
	$(CC) $(CCFLAGS) $(INCLUDE) $(FRAMEWORKS) -isysroot $(SDK) -c iosurface.c -o $(bin)/iosurface.o

$(bin)/applevxd390.o: applevxd390.c applevxd390.h
	$(CC) $(CCFLAGS) $(INCLUDE) $(FRAMEWORKS) -isysroot $(SDK) -c applevxd390.c -o $(bin)/applevxd390.o

$(bin)/base64-utils.o: base64-utils.c base64-utils.h
	$(CC) $(CCFLAGS) $(INCLUDE) $(FRAMEWORKS) -isysroot $(SDK) -c base64-utils.c -o $(bin)/base64-utils.o

$(bin)/mach-ports.o: mach-ports.c mach-ports.h
	$(CC) $(CCFLAGS) $(INCLUDE) $(FRAMEWORKS) -isysroot $(SDK) -c mach-ports.c -o $(bin)/mach-ports.o

$(bin)/gc.o: gc.c gc.h
	$(CC) $(CCFLAGS) $(INCLUDE) $(FRAMEWORKS) -isysroot $(SDK) -c gc.c -o $(bin)/gc.o

$(bin)/pipes.o: pipes.c pipes.h
	$(CC) $(CCFLAGS) $(INCLUDE) $(FRAMEWORKS) -isysroot $(SDK) -c pipes.c -o $(bin)/pipes.o

.PHONY: clean install run

clean:
	rm -rf build

install: all
	scp $(bin)/poc root@$(DEVICE_IP):/usr/local/bin

run: install
	ssh root@$(DEVICE_IP) /usr/local/bin/poc
