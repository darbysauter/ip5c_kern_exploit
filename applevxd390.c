#include "applevxd390.h"


io_connect_t createDecoder(uint32_t surface_id) {
    kern_return_t err;

	CFMutableDictionaryRef matching = IOServiceMatching("AppleVXD390");
	if (!matching) {
		printf("Unable to create service matching dictionary\n");
		return MACH_PORT_NULL;
	}

	io_iterator_t iterator;
	err = IOServiceGetMatchingServices(kIOMasterPortDefault, matching, &iterator);

	if (err != KERN_SUCCESS) {
		printf("no matches\n");
		return MACH_PORT_NULL;
	}

	io_service_t service = IOIteratorNext(iterator);

	if (service == IO_OBJECT_NULL) {
		printf("unable to find service\n");
		return MACH_PORT_NULL;
	}
	printf("got service: %x\n", service);

	io_connect_t conn = MACH_PORT_NULL;
	err = IOServiceOpen(service, mach_task_self(), 1, &conn); // type 1?
	if (err != KERN_SUCCESS) {
		printf("unable to get user client connection\n");
		return MACH_PORT_NULL;
	}
	printf("got user client connection: %x\n", conn);

    size_t create_dec_input_buffer_size;
    size_t create_dec_output_buffer_size;
    char create_dec_input_buffer[CREATE_DECODER_INPUT_SIZE];
    char create_dec_output_buffer[CREATE_DECODER_OUTPUT_SIZE];

    create_dec_input_buffer_size = CREATE_DECODER_INPUT_SIZE;
    create_dec_output_buffer_size = CREATE_DECODER_OUTPUT_SIZE;
    
    bzero(create_dec_input_buffer, create_dec_input_buffer_size);
    bzero(create_dec_output_buffer, create_dec_output_buffer_size);

    
    memcpy(&create_dec_input_buffer[0x58], &surface_id, sizeof(uint32_t));
    create_dec_input_buffer[0x8] = 1;

	err = IOConnectCallStructMethod(conn, 0,
				    create_dec_input_buffer, sizeof(create_dec_input_buffer),
				    create_dec_output_buffer, &create_dec_output_buffer_size);

	if (err != KERN_SUCCESS) {
		printf("Create Decoder Failed: 0x%x %d\n", err, err);
		return MACH_PORT_NULL;
	}
		
    printf("Successfully Created Decoder\n");
    return conn;
}


int destroyDecoder(io_connect_t conn) {
    kern_return_t err;

    size_t destroy_dec_input_buffer_size;
    size_t destroy_dec_output_buffer_size;
    char destroy_dec_input_buffer[DESTROY_DECODER_INPUT_SIZE];
    char destroy_dec_output_buffer[DESTROY_DECODER_OUTPUT_SIZE];

    destroy_dec_input_buffer_size = DESTROY_DECODER_INPUT_SIZE;
    destroy_dec_output_buffer_size = DESTROY_DECODER_OUTPUT_SIZE;
    
    bzero(destroy_dec_input_buffer, destroy_dec_input_buffer_size);
    bzero(destroy_dec_output_buffer, destroy_dec_output_buffer_size);

	err = IOConnectCallStructMethod(conn, 1,
				    destroy_dec_input_buffer, sizeof(destroy_dec_input_buffer),
				    destroy_dec_output_buffer, &destroy_dec_output_buffer_size);

	if (err != KERN_SUCCESS) {
		printf("Destroy Decoder Failed: 0x%x %d\n", err, err);
		return 0;
	}
		
    printf("Successfully Destroyed Decoder\n");
    return conn;
}

